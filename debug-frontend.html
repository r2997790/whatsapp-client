<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Web Client - Debug Mode</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .debug-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #25D366;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #128C7E; }
        .qr-container {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }
        .qr-container.has-qr {
            border-color: #25D366;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîß WhatsApp Web Client - Debug Mode</h1>
    
    <div class="debug-panel">
        <h3>üîå Connection Status</h3>
        <div id="connectionStatus" class="status warning">Testing connection...</div>
        <div id="backendUrl" class="status info"></div>
        <div id="socketStatus" class="status warning">Socket: Not connected</div>
        
        <h3>üß™ Connection Tests</h3>
        <button onclick="testBackendHealth()">Test Backend Health</button>
        <button onclick="testSocketConnection()">Test Socket Connection</button>
        <button onclick="requestQRCode()">Request QR Code</button>
        <button onclick="forceReconnect()">Force Reconnect</button>
        
        <div id="testResults"></div>
    </div>

    <div class="debug-panel">
        <h3>üì± QR Code Area</h3>
        <div class="qr-container" id="qrContainer">
            <div id="qrPlaceholder">No QR code generated yet</div>
            <img id="qrCode" style="display: none; max-width: 300px;" alt="QR Code">
        </div>
        <button onclick="connectWhatsApp()">üîå Connect WhatsApp</button>
    </div>

    <div class="debug-panel">
        <h3>üìä Real-time Logs</h3>
        <pre id="logOutput">Starting debug session...\n</pre>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        // Configuration
        const BACKEND_URL = window.location.hostname.includes('localhost') 
            ? 'http://localhost:3001' 
            : 'https://whatsapp-service-production-66d3.up.railway.app';
        
        let socket = null;
        let connectionStatus = 'disconnected';
        
        // DOM Elements
        const connectionStatusEl = document.getElementById('connectionStatus');
        const backendUrlEl = document.getElementById('backendUrl');
        const socketStatusEl = document.getElementById('socketStatus');
        const testResultsEl = document.getElementById('testResults');
        const qrContainer = document.getElementById('qrContainer');
        const qrCode = document.getElementById('qrCode');
        const qrPlaceholder = document.getElementById('qrPlaceholder');
        const logOutput = document.getElementById('logOutput');

        // Logging function
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logOutput.textContent += logEntry;
            logOutput.scrollTop = logOutput.scrollHeight;
            console.log(`[WhatsApp Debug] ${logEntry.trim()}`);
        }

        // Initialize
        function init() {
            backendUrlEl.textContent = `Backend URL: ${BACKEND_URL}`;
            backendUrlEl.className = 'status info';
            log(`Initializing with backend: ${BACKEND_URL}`);
            
            // Test basic connectivity
            testBackendHealth();
            
            // Initialize socket after delay
            setTimeout(initSocket, 2000);
        }

        // Test backend health
        async function testBackendHealth() {
            try {
                log('Testing backend health endpoint...');
                const response = await fetch(`${BACKEND_URL}/health`);
                const data = await response.json();
                
                if (response.ok) {
                    connectionStatusEl.textContent = `‚úÖ Backend Online - Status: ${data.whatsapp_status}`;
                    connectionStatusEl.className = 'status success';
                    log(`Backend health OK: ${JSON.stringify(data)}`);
                    
                    testResultsEl.innerHTML = `
                        <div class="status success">
                            <strong>Backend Health:</strong><br>
                            Status: ${data.status}<br>
                            WhatsApp Status: ${data.whatsapp_status}<br>
                            Connected Clients: ${data.clients_connected}<br>
                            Has QR: ${data.has_qr}<br>
                            Version: ${data.version}
                        </div>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                connectionStatusEl.textContent = `‚ùå Backend Offline - Error: ${error.message}`;
                connectionStatusEl.className = 'status error';
                log(`Backend health failed: ${error.message}`, 'error');
                
                testResultsEl.innerHTML = `
                    <div class="status error">
                        <strong>Backend Health Failed:</strong><br>
                        Error: ${error.message}<br>
                        Check if backend is deployed and running
                    </div>
                `;
            }
        }

        // Initialize socket connection
        function initSocket() {
            try {
                log('Initializing Socket.io connection...');
                
                if (socket) {
                    socket.disconnect();
                }
                
                socket = io(BACKEND_URL, {
                    transports: ['websocket', 'polling'],
                    timeout: 10000,
                    forceNew: true
                });

                socket.on('connect', () => {
                    socketStatusEl.textContent = '‚úÖ Socket: Connected';
                    socketStatusEl.className = 'status success';
                    log('Socket.io connected successfully');
                });

                socket.on('disconnect', (reason) => {
                    socketStatusEl.textContent = `‚ùå Socket: Disconnected (${reason})`;
                    socketStatusEl.className = 'status error';
                    log(`Socket.io disconnected: ${reason}`, 'error');
                });

                socket.on('connect_error', (error) => {
                    socketStatusEl.textContent = `‚ùå Socket: Connection Error`;
                    socketStatusEl.className = 'status error';
                    log(`Socket.io connection error: ${error.message}`, 'error');
                });

                socket.on('status_update', (data) => {
                    log(`Status update received: ${JSON.stringify(data)}`);
                    connectionStatus = data.status;
                    
                    if (data.qr) {
                        showQRCode(data.qr);
                    }
                });

                socket.on('qr_updated', (data) => {
                    log(`QR code update received`);
                    showQRCode(data.qr);
                });

            } catch (error) {
                log(`Socket initialization failed: ${error.message}`, 'error');
            }
        }

        // Show QR code
        function showQRCode(qrDataUrl) {
            qrCode.src = qrDataUrl;
            qrCode.style.display = 'block';
            qrPlaceholder.style.display = 'none';
            qrContainer.classList.add('has-qr');
            log('‚úÖ QR Code displayed successfully');
        }

        // Test socket connection
        function testSocketConnection() {
            if (socket && socket.connected) {
                log('Socket is connected, sending test message...');
                socket.emit('test_connection');
                socket.on('test_response', (data) => {
                    log(`Test response: ${JSON.stringify(data)}`);
                });
            } else {
                log('Socket not connected, attempting to reconnect...', 'warning');
                initSocket();
            }
        }

        // Request QR code
        async function requestQRCode() {
            try {
                log('Requesting QR code via API...');
                const response = await fetch(`${BACKEND_URL}/api/qr`);
                const data = await response.json();
                
                if (response.ok && data.qr) {
                    showQRCode(data.qr);
                    log('QR code received via API');
                } else {
                    log(`QR code not available: ${data.message || data.error}`, 'warning');
                }
            } catch (error) {
                log(`QR code request failed: ${error.message}`, 'error');
            }
        }

        // Force reconnect
        async function forceReconnect() {
            try {
                log('Forcing backend reconnection...');
                
                // Via Socket.io
                if (socket && socket.connected) {
                    socket.emit('reconnect_whatsapp');
                }
                
                // Via API
                const response = await fetch(`${BACKEND_URL}/api/force-reconnect`, {
                    method: 'POST'
                });
                const data = await response.json();
                log(`Force reconnect response: ${JSON.stringify(data)}`);
                
            } catch (error) {
                log(`Force reconnect failed: ${error.message}`, 'error');
            }
        }

        // Connect WhatsApp
        function connectWhatsApp() {
            log('Connect WhatsApp button clicked');
            
            if (socket && socket.connected) {
                log('Sending reconnect_whatsapp via socket...');
                socket.emit('reconnect_whatsapp');
            } else {
                log('Socket not connected, using API fallback...', 'warning');
                forceReconnect();
            }
        }

        // Clear logs
        function clearLogs() {
            logOutput.textContent = 'Logs cleared...\n';
        }

        // Start initialization
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
